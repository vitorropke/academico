/**********************************************************************************
// TiledScroll (Código Fonte)
//
// Criação:     22 Out 2012
// Atualização: 12 Nov 2021
// Compilador:  Visual C++ 2019
//
// Descrição:   Desenhando e movimentando um background formado por blocos
//
**********************************************************************************/

#include "Engine.h"
#include "TiledScroll.h"

// ------------------------------------------------------------------------------

void TiledScroll::Init()
{
    int MapData[40 * 40] =
    {
        36,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,37,
        35,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,46,14,15,16,30,31,30,30,30,30,30,30,30,30,30,30,33,
        35,30,30,30,30,10,10,10,30,30,30,30,30,30,30,30,2,2,2,2,30,30,30,30,14,15,16,30,30,30,30,30,30,30,30,30,30,32,30,33,
        35,30,30,30,2,10,10,10,2,30,30,30,30,30,30,30,30,30,30,30,30,30,30,31,22,23,24,30,30,30,30,34,34,30,30,30,32,30,30,33,
        35,30,30,30,30,10,10,10,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,1,2,3,30,30,31,30,30,30,30,40,40,40,30,30,33,
        35,30,30,30,30,30,10,30,30,30,30,25,26,26,26,26,26,26,26,26,26,26,26,27,9,10,11,30,30,30,30,30,30,30,30,30,30,30,30,33,
        35,30,30,30,30,30,10,30,30,30,30,33,34,34,34,34,34,34,34,34,34,34,34,35,9,10,11,30,30,30,30,30,30,30,30,30,30,30,30,33,
        35,30,30,10,10,10,10,10,10,10,30,33,34,36,42,37,34,34,34,34,34,34,34,35,9,10,11,30,30,30,30,47,30,42,30,30,30,32,30,33,
        35,30,30,30,30,30,10,30,30,30,30,33,34,35,30,33,34,34,34,34,34,34,34,35,9,10,11,30,30,30,30,30,30,30,30,30,40,30,30,33,
        35,30,30,30,30,30,10,30,38,30,30,33,34,35,48,33,34,34,34,34,34,34,34,35,9,10,11,30,47,30,30,30,30,30,30,40,40,30,30,33,
        35,30,30,30,48,48,10,30,30,30,30,33,34,44,26,45,34,34,34,34,34,34,34,35,9,10,11,30,30,30,47,30,30,30,30,40,30,30,30,33,
        35,30,30,40,30,30,10,40,30,30,30,33,34,34,34,34,34,34,34,36,42,37,34,35,9,10,11,30,30,30,30,30,30,30,30,40,30,30,30,33,
        35,30,30,30,30,10,10,10,30,38,30,33,34,34,34,34,34,34,34,44,26,45,34,35,9,10,11,30,30,30,30,30,30,40,40,40,30,30,30,33,
        35,39,30,30,10,10,30,10,10,30,30,33,34,34,34,34,34,34,34,34,34,34,34,35,9,10,11,30,30,30,30,30,30,40,30,30,30,30,30,33,
        35,30,30,10,10,30,30,30,10,10,30,41,42,42,42,42,42,42,42,42,42,42,42,43,9,10,11,30,30,30,30,30,30,40,30,30,30,30,30,33,
        35,7,8,10,2,2,2,2,2,10,2,2,3,1,2,2,2,2,2,2,2,2,2,2,29,10,11,30,30,30,30,30,30,30,30,30,30,30,30,33,
        35,15,16,9,10,10,10,10,10,10,10,10,11,9,10,10,10,10,10,10,10,10,10,10,10,10,11,30,30,30,17,30,30,30,30,30,30,30,30,33,
        35,23,24,17,18,18,18,18,18,18,18,18,19,17,18,18,18,18,18,18,18,18,18,18,18,18,19,30,30,30,30,30,30,30,30,30,30,30,30,33,
        35,30,39,30,30,30,30,30,30,30,48,32,30,30,32,48,30,30,30,30,30,30,30,30,30,30,30,30,30,40,40,40,40,40,30,30,30,30,32,33,
        35,30,30,30,39,30,30,30,30,30,30,32,30,30,32,30,30,30,6,7,7,7,8,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,33,
        35,30,30,30,30,30,30,30,30,30,48,32,30,30,32,48,30,30,14,15,15,15,16,30,30,30,25,26,26,26,26,26,26,26,26,26,26,26,27,33,
        35,30,30,30,30,30,30,30,30,30,30,32,30,30,32,30,30,30,14,15,15,15,16,30,46,30,33,34,34,34,34,34,34,34,34,36,42,37,35,33,
        35,30,30,30,30,30,30,30,30,30,48,32,30,30,32,48,30,30,14,15,15,15,16,30,30,30,33,34,34,34,34,34,34,34,34,35,48,33,35,33,
        35,30,30,30,30,30,30,30,30,30,30,32,30,30,32,30,30,30,22,23,23,23,24,30,30,47,33,34,34,34,34,34,34,34,34,35,48,33,35,33,
        35,30,30,30,30,30,30,30,30,30,48,32,30,30,32,48,30,30,30,30,30,30,39,30,30,30,33,34,34,34,34,34,34,34,34,35,48,33,35,33,
        35,30,30,2,2,30,30,30,10,10,10,10,30,30,10,10,10,10,30,30,30,30,30,30,30,30,33,34,34,34,34,34,34,34,34,44,26,45,35,33,
        35,30,30,30,30,30,30,30,10,34,34,10,34,34,10,34,34,10,30,30,30,30,30,30,47,30,33,34,34,34,34,34,34,34,34,34,34,34,35,33,
        35,30,10,10,10,30,30,30,10,34,34,34,34,34,34,34,34,10,30,30,34,30,34,30,30,30,33,34,34,34,34,34,34,34,34,34,34,34,35,33,
        35,30,10,10,10,30,30,30,10,34,34,10,34,34,10,34,34,10,30,30,30,30,30,30,30,30,33,34,34,34,34,34,34,34,34,34,34,34,35,33,
        35,30,10,10,10,30,30,30,10,10,10,10,10,10,10,10,10,10,30,34,30,30,30,34,30,30,41,42,42,42,42,42,42,42,42,42,42,42,43,33,
        35,30,30,10,30,30,30,30,30,10,10,10,10,10,10,10,10,30,30,34,34,34,34,34,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,33,
        35,30,30,10,30,30,30,30,30,30,10,10,10,10,10,10,30,30,30,30,30,30,30,30,30,30,30,30,31,30,30,30,30,30,30,30,32,30,30,33,
        35,30,30,10,30,30,31,31,31,30,30,10,10,10,10,30,30,30,30,34,34,34,34,34,30,30,30,30,30,30,30,31,30,30,30,30,30,30,30,33,
        35,30,30,10,30,30,30,31,31,30,30,30,10,10,30,30,30,30,30,34,31,31,31,34,30,30,30,30,30,30,30,32,30,30,30,31,30,30,30,33,
        35,30,10,10,10,30,30,30,31,30,30,30,30,30,30,30,31,31,31,31,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,32,30,33,
        35,30,10,30,10,30,30,30,31,30,30,30,30,30,30,30,31,30,30,30,34,30,34,30,30,48,48,48,48,30,30,30,30,31,30,30,30,30,30,33,
        35,30,30,30,30,30,30,30,31,31,31,31,30,30,31,31,31,30,30,30,30,30,30,30,30,48,48,48,48,30,30,30,30,30,30,30,30,30,30,33,
        35,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,2,2,2,2,30,34,34,34,34,30,30,30,30,30,30,30,30,30,30,30,33,
        35,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,33,
        44,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,45
    };

    // carrega pano de fundo
    tiles = new Image("Resources/Desert.bmp", 32, 32, 8, MapData, 40, 40);
    backg = new Background(tiles);

    // carrega sprites
    infoBox = new Sprite("Resources/InfoBox.png");
    keyMap  = new Sprite("Resources/Keymap.png");

    // carrega fontes
    font = new Font("Resources/Tahoma14.png");
    font->Spacing("Resources/Tahoma14.dat");
    bold = new Font("Resources/Tahoma14b.png");
    bold->Spacing("Resources/Tahoma14b.dat");

    // inicializa viewport para o centro do background
    viewport.left = (backg->Width() - window->Width()) / 2.0f;
    viewport.right = viewport.left + window->Width();
    viewport.top = (backg->Height() - window->Height()) / 2.0f;
    viewport.bottom = viewport.top + window->Height();

    // inicializa velocidade de rolamento da tela
    scrollSpeed = 400;

    // exibe ponto-flutuantes sem casas
    text << std::fixed;
    text.precision(0);
}

// ------------------------------------------------------------------------------

void TiledScroll::Update()
{
    // sai com o pressionamento da tecla ESC
    if (window->KeyDown(VK_ESCAPE))
        window->Close();

    // deslocamento padrão
    float delta = scrollSpeed * gameTime;

    // movimenta viewport
    if (window->KeyDown(VK_LEFT))
    {
        viewport.left -= delta;
        viewport.right -= delta;

        if (viewport.left < 0)
        {
            viewport.left = 0;
            viewport.right = window->Width();
        }
    }

    if (window->KeyDown(VK_RIGHT))
    {
        viewport.left += delta;
        viewport.right += delta;

        if (viewport.right > backg->Width())
        {
            viewport.left = backg->Width() - window->Width();
            viewport.right = backg->Width();
        }
    }

    if (window->KeyDown(VK_UP))
    {
        viewport.top -= delta;
        viewport.bottom -= delta;

        if (viewport.top < 0)
        {
            viewport.top = 0;
            viewport.bottom = window->Height();
        }
    }

    if (window->KeyDown(VK_DOWN))
    {
        viewport.top += delta;
        viewport.bottom += delta;

        if (viewport.bottom > backg->Height())
        {
            viewport.top = backg->Height() - window->Height();
            viewport.bottom = backg->Height();
        }
    }
} 

// ------------------------------------------------------------------------------

void TiledScroll::Draw()
{
    // desenha o pano de fundo
    backg->Draw(viewport);
    
    // desenha elementos da interface
    infoBox->Draw(142, 98, 0.2f);
    keyMap->Draw(window->CenterX(), window->Height() - 16.0f, 0.2f);
    
    // desenha texto
    text.str("");
    text << "Tiled Map";
    bold->Draw(60, 70, text.str());

    text.str("");
    text << "Janela: " << window->Width() << " x " << window->Height();
    font->Draw(60, 100, text.str());

    text.str("");
    text << "Background: " << backg->Width() << " x " << backg->Height();
    font->Draw(60, 120, text.str());
    
    text.str("");
    text << "Viewport: (" << viewport.left << "," << viewport.top << ") a (" << viewport.right << "," << viewport.bottom << ")";
    font->Draw(60, 140, text.str());
    
    text.str("");
    text << "Use as setas para mover a Viewport";
    font->Draw(window->CenterX() - 82.0f, window->Height() - 7.0f, text.str());
} 

// ------------------------------------------------------------------------------

void TiledScroll::Finalize()
{
    delete infoBox;
    delete keyMap;
    delete tiles;
    delete backg;
    delete font;
    delete bold;
}


// ------------------------------------------------------------------------------
//                                  WinMain                                      
// ------------------------------------------------------------------------------

int APIENTRY WinMain(_In_ HINSTANCE hInstance, _In_opt_ HINSTANCE hPrevInstance, 
                     _In_ LPSTR lpCmdLine, _In_ int nCmdShow)
{
    Engine * engine = new Engine();

    // configura motor
    engine->window->Mode(WINDOWED);
    engine->window->Size(1000, 600);
    engine->window->Color(0, 0, 0);
    engine->window->Title("Tiled Map");
    engine->window->Icon(IDI_ICON);
    engine->window->Cursor(IDC_CURSOR);

    // inicia o jogo
    engine->Start(new TiledScroll());

    delete engine;
    return 0;
}

// ----------------------------------------------------------------------------

